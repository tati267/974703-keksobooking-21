(()=>{"use strict";!function(){const e="Escape",t=()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)};window.message={errorHandler:n=>{const i=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=i.querySelector(".error__button");i.querySelector(".error__message").textContent=n,document.querySelector("main").appendChild(i),i.setAttribute("tabindex","0"),i.focus(),i.addEventListener("keydown",(n=>{n.key===e&&t()})),i.addEventListener("click",(()=>{t()})),o.addEventListener("click",(()=>{t(),window.form.makePageDisabled()}))},successHandler:()=>{const n=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.querySelector("main").appendChild(n),n.setAttribute("tabindex","0"),n.focus(),n.addEventListener("keydown",(n=>{n.key===e&&t()})),n.addEventListener("click",(()=>{t()}))}}}(),function(){const e="https://21.javascript.pages.academy/keksobooking",t="GET",n="POST",i=(e,t,n)=>{e.responseType="json",e.addEventListener("load",(()=>{200===e.status?t(e.response):n("Ошибка сервера "+e.status)})),e.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${e.timeout} мс`)})),e.timeout=1e4};window.backend={load:(n,o)=>{const r=new XMLHttpRequest;i(r,n,o),r.open(t,e+"/data"),r.send()},save:(t,o,r)=>{const a=new XMLHttpRequest;i(a,o,r),a.open(n,e),a.send(t)}}}(),function(){const e="any",t={low:{min:0,max:1e4},middle:{min:1e4,max:5e4},high:{min:5e4,max:1/0}},n=document.querySelector(".map__filters-container"),i=n.querySelector("#housing-type"),o=n.querySelector("#housing-price"),r=n.querySelector("#housing-rooms"),a=n.querySelector("#housing-guests"),d=n.querySelector("#housing-features").querySelectorAll('input[name="features"]'),l=n=>o.value===e||n.offer.price<=t[o.value].max&&n.offer.price>=t[o.value].min,u=t=>r.value===e||t.offer.rooms===parseInt(r.value,10),s=t=>a.value===e||t.offer.guests===parseInt(a.value,10),c=e=>{for(let t=0;t<d.length;t++)if(d[t].checked&&!e.offer.features.includes(d[t].value))return!1;return!0},m=t=>{let n=[];for(let r=0;r<t.length;r++)n.length<5&&(o=t[r],i.value===e||o.offer.type===i.value)&&l(t[r])&&u(t[r])&&s(t[r])&&c(t[r])&&n.push(t[r]);var o;return n};n.addEventListener("change",((e,t)=>{let n=null;return(...e)=>{n&&window.clearTimeout(n),n=window.setTimeout((()=>{(()=>{const e=m(window.dataWithId);window.card.close(),window.pin.deletePins(),window.pin.createPin(e)})(...e)}),500)}})()),window.filter={filterData:m}}(),function(){const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),n=t.querySelector(".map__pin--main");window.util={map:e,pins:t,mainPin:n,offerTypes:{palace:{name:"Дворец",min:1e4},flat:{name:"Квартира",min:1e3},house:{name:"Дом",min:5e3},bungalow:{name:"Бунгало",min:0}},MAIN_PIN:{width:62,height:62,heightActive:84,initialTop:375,initialLeft:570,minX:0,maxX:1200,minY:130,maxY:630},addIdToOffer:e=>(e.forEach(((e,t)=>(e.offer.offerId=t,e.offer.offerId))),e)}}(),function(){const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),n=e=>{0===e.button&&window.form.makePageActive()},i=e=>{"Enter"===e.key&&window.form.makePageActive()};window.pin={createPin:t=>{const n=document.createDocumentFragment();t.forEach((t=>{const i=e.cloneNode(!0),o=i.querySelector("img");i.style=`left: ${t.location.x-o.width/2}px;\n                   top: ${t.location.y-o.height}px;`,o.src=t.author.avatar,o.alt=t.offer.title,n.append(i),i.addEventListener("click",(()=>{window.card.open(t)}))})),window.util.pins.appendChild(n)},deletePins:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},mainPinSetInitial:()=>{window.util.mainPin.style.top=window.util.MAIN_PIN.initialTop+"px",window.util.mainPin.style.left=window.util.MAIN_PIN.initialLeft+"px"},addMainPinListener:()=>{window.util.mainPin.addEventListener("mousedown",n),window.util.mainPin.addEventListener("keydown",i)},removeMainPinListener:()=>{window.util.mainPin.removeEventListener("mousedown",n),window.util.mainPin.removeEventListener("keydown",i)}}}(),function(){const e=document.querySelector("#card").content.querySelector(".map__card"),t=e=>{((e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())})(e,n)},n=()=>{const e=window.util.map.querySelector(".map__card");e&&(e.remove(),document.removeEventListener("keydown",t))};window.card={open:i=>{n(),(t=>{const n=e.cloneNode(!0),i=t.offer.rooms,o=t.offer.guests;window.util.map.insertBefore(n,window.util.pins),n.querySelector(".popup__title").textContent=t.offer.title,n.querySelector(".popup__text--address").textContent=t.offer.address,n.querySelector(".popup__text--price").innerHTML=t.offer.price+" &#x20bd/ночь",n.querySelector(".popup__type").textContent=window.util.offerTypes[t.offer.type].name,n.querySelector(".popup__text--capacity").textContent=`${i} комнаты  для ${o} гостей `,n.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выезд после ${t.offer.checkout}`,((e,t)=>{const n=t.querySelector(".popup__features");n.innerHTML="";for(let t=0;t<e.offer.features.length;t++){let i=document.createElement("li");i.classList.add("popup__feature","popup__feature--"+e.offer.features[t]),n.appendChild(i)}})(t,n),n.querySelector(".popup__description").textContent=t.offer.description,((e,t)=>{const n=t.querySelector(".popup__photos"),i=n.querySelector(".popup__photo");n.innerHTML="",i.src=""+e.offer.photos[0];for(let t=1;t<e.offer.photos.length;t++){let o=i.cloneNode();o.src=""+e.offer.photos[t],n.appendChild(o)}})(t,n),n.querySelector(".popup__avatar").src=t.author.avatar,e&&document.querySelector(".popup__close").addEventListener("click",(function(){document.querySelector(".map__card").remove()}));const r=document.querySelector(".map__filters-container");window.util.map.insertBefore(n,r)})(i),document.addEventListener("keydown",t)},close:n}}(),window.util.mainPin.addEventListener("mousedown",(e=>{e.preventDefault();let t={x:e.clientX,y:e.clientY},n=!1;const i=e=>{e.preventDefault(),n=!0;let i=t.x-e.clientX,o=t.y-e.clientY;t={x:e.clientX,y:e.clientY},(()=>{let e=window.util.mainPin.offsetTop-o,t=window.util.mainPin.offsetLeft-i;t>=window.util.MAIN_PIN.minX-window.util.MAIN_PIN.width/2&&t<=window.util.MAIN_PIN.maxX-window.util.MAIN_PIN.width/2&&e>=window.util.MAIN_PIN.minY-window.util.MAIN_PIN.heightActive&&e<=window.util.MAIN_PIN.maxY-window.util.MAIN_PIN.heightActive&&(window.util.mainPin.style.top=e+"px",window.util.mainPin.style.left=t+"px",window.form.setaddress())})()},o=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",o),n){const e=function(t){t.preventDefault(),window.util.mainPin.removeEventListener("click",e)};window.util.mainPin.addEventListener("click",e)}};document.addEventListener("mousemove",i),document.addEventListener("mouseup",o)})),function(){const e=document.querySelector(".map__filters"),t=document.querySelector(".ad-form"),n=t.querySelector("#title"),i=t.querySelector("#address"),o=t.querySelector("#type"),r=t.querySelector("#room_number"),a=document.querySelector("#capacity").querySelectorAll("option"),d=t.querySelector("#price"),l=document.querySelectorAll("fieldset"),u=document.querySelector("#timein"),s=document.querySelector("#timeout"),c={1:[1],2:[1,2],3:[1,2,3],100:[0]};n.addEventListener("input",(()=>{const e=n.value.length;e<30?n.setCustomValidity(`Еще ${30-e} симв`):e>100?n.setCustomValidity(`Удалите лишние ${e-100} симв`):n.setCustomValidity(""),n.reportValidity()})),o.addEventListener("change",(e=>{var t;t=e.target.value,d.setAttribute("minvalue",window.util.offerTypes[t].min),d.setAttribute("placeholder",window.util.offerTypes[t].min)})),d.addEventListener("input",(function(){const e=o.value,t=d.value.input,n=window.util.offerTypes[e].min;var i;d.min=n,t<n&&(i=n,d.setCustomValidity("Минимальная стоимость этого жилья равна "+i)),d.reportValidity()})),u.addEventListener("change",(()=>{s.value=u.value})),s.addEventListener("change",(()=>{u.value=s.value})),r.addEventListener("change",(e=>{var t;t=e.target.value,a.forEach((e=>{e.disabled=!0})),c[t].forEach((e=>{a.forEach((t=>{Number(t.value)===e&&(t.disabled=!1,t.selected=!0)}))}))}));const m=()=>{window.util.map.classList.add("map--faded"),t.classList.add("ad-form--disabled"),e.classList.add("map__filters--disabled"),l.forEach((e=>{e.setAttribute("disabled","")})),window.pin.addMainPinListener(),window.pin.mainPinSetInitial(),w(!0)};function p(e){window.dataWithId=window.util.addIdToOffer(e),window.pin.createPin(window.filter.filterData(window.dataWithId))}const w=e=>{const[t,n]=(e=>{const t=window.util.MAIN_PIN.width/2,n=e?window.util.MAIN_PIN.height/2:window.util.MAIN_PIN.heightActive;return[window.util.mainPin.offsetLeft+t,window.util.mainPin.offsetTop+n]})(e);i.value=`${t}, ${n}`};m(),t.addEventListener("submit",(e=>{e.preventDefault(),window.backend.save(new FormData(t),window.message.successHandler,window.message.errorHandler),t.reset(),window.pin.deletePins(),window.card.close(),m()})),window.form={setaddress:w,makePageDisabled:m,makePageActive:()=>{window.util.map.classList.remove("map--faded"),t.classList.remove("ad-form--disabled"),e.classList.remove("map__filters--disabled"),window.backend.load(p,window.message.errorHandler),l.forEach((e=>{e.removeAttribute("disabled","")})),window.pin.removeMainPinListener(),w()}}}()})();
